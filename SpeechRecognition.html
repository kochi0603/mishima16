<!DOCTYPE html>
<html>
<head lang="ja-JP">
<meta charset="utf-8">
<title>Speak Test</title>
<script type="text/javascript" src="jquery-3.5.1.js"></script>
<script type="text/javascript">
<!--
        $(document).ready(function(){
                function setStatus(str) {
                        $("#STATUS_LABEL").val( str );
                };
                function showProcess(str) {
                        $("#LOG_AREA").val( str );
                };
                function appendResult(str) {
                        $("#RESULT_AREA").val( $("#RESULT_AREA").val() + "\n" + str );
                };

                // Chrome と Firefox 両方に対応するための書き方
                const SpeechRecognition = webkitSpeechRecognition || SpeechRecognition;
                const rec = new SpeechRecognition();

                rec.continuous = true; // 継続して音声認識を行う
                rec.interimResults = true;　// 変換途中の結果を受け取りたいときtrueにする。変換途中の場合、isFinalはfalseとなっている
                rec.lang = "ja-JP" // "en-US"
                let previous_word = "";
                let current_word = "";

                rec.addEventListener('start', function() {
                        setStatus("開始");
                });
                rec.addEventListener('end', function() {
                        setStatus("終了");
                });
                rec.addEventListener('audiostart', function() {
                        setStatus("準備OK");
                });

                rec.addEventListener('result', function(event) {
                        if( event.results.length ) {
                                for ( let ia = event.resultIndex; ia < event.results.length; ia++) {
                                        if( event.results[ia].isFinal ) {
                                                current_word = event.results[ia][0].transcript;
                                                setStatus( "認識結果[" + ia + "]");
                                                //appendResult( "認識結果[" + ia + "]\t" + current_word );
                                                appendResult( current_word );
                                                if ( current_word == '変換' ){
                                                        let colorStr = "white";
                                                        if ( previous_word == '青' ){
                                                                colorStr = "blue";
                                                        } else if ( previous_word == '緑' ){
                                                                colorStr = "green";
                                                        }
                                                        $('#RESULT_AREA').css('background-color', colorStr );
                                                }
                                                previous_word = current_word;
                                        } else {
                                                let possiblity = [].slice.call( event.results[ia] ).map( 
                                                                function( result, ib ) { return result.transcript; } 
                                                        ).join('\n\n');
                                                showProcess( possiblity );
                                        }
                                }
                        }
                });

                $("#START_BTN").on( 'click', function() {
                        rec.start();
                } );

                $("#STOP_BTN").on( 'click', function() {
                        rec.stop();
                } );
        });
//-->
</script>
</head>
<body>
    <button id="START_BTN">start</button>
    <button id="STOP_BTN">stop</button>
    <button id="STATUS_LABEL" disabled></button>
    <br><font size="2">ログ</font><br>
    <textarea id="LOG_AREA" rows=4 cols=80></textarea>
    <br><font size="2">認識結果</font><br>
    <textarea id="RESULT_AREA" rows=30 cols=80></textarea>
</body>
</html>
